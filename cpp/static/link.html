<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>生成订单链接</title>
    <link href="images/favicon.ico" rel="icon" type="image/x-icon">

    <!-- 关键 CSS -->
    <link href="fonts/remixicon.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">


    <!-- 非关键 CSS 预加载 -->
    <link as="style" href="css/modal.css" onload="this.onload=null;this.rel='stylesheet'" rel="preload">
    <noscript>
        <link href="css/modal.css" rel="stylesheet">
    </noscript>
    <style>
        .selected-sku-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .selected-sku-item .sku-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex: 1;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .quantity-control input[type="number"] {
            width: 60px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .delete-button {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            margin-left: 10px;
        }

        .delete-button:hover {
            color: #c82333;
        }

        .custom-alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 1000;
            transition: transform 0.3s ease-in-out;
            font-size: 14px;
        }

        .custom-alert.show {
            transform: translateX(-50%) translateY(0);
        }

        .link-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }

        .link-container input {
            flex: 1;
            min-width: 0;
            padding: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .link-container button {
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .link-container button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
<div class="container">
    <header class="header-container">
        <div>
            <h2>生成订单链接</h2>
        </div>
        <a class="header-button" href="index.html">
            <i class="ri-arrow-left-line"></i>
            返回
        </a>
    </header>

    <div class="form-group">
        <label for="urlInput">商品链接:</label>
        <div class="input-group">
            <input id="urlInput" placeholder="输入商品链接" type="text">
            <button onclick="fetchItemInfo()" type="button">提交</button>
        </div>
    </div>

    <div class="product-info" id="productInfo"></div>
    <div class="sku-info" id="skuInfo"></div>
    <div class="selected-skus" id="selectedSkus"></div>
    <div class="generated-link-container" id="generatedLink"></div>
</div>

<script>
    const globalState = {
        itemId: '',
        itemPrice: 0,
        itemStock: 0
    };

    async function expandShortUrl(shortUrl) {
        if (!shortUrl) {
            showAlert('请输入链接');
            return null;
        }

        try {
            const response = await fetch(`api/expand?shortUrl=${encodeURIComponent(shortUrl)}`, {
                method: 'GET'
            });

            if (!response.ok) {
                throw new Error('网络请求失败');
            }

            const text = await response.text();
            return text;
        } catch (error) {
            console.error('展开短链接失败:', error);
            showAlert('展开短链接失败');
            return null;
        }
    }

    function extractHttpLink(text) {
        if (!text) return null;
        const regex = /https?:\/\/[^\s]+/g;
        const matches = text.match(regex);
        return matches ? matches[0] : null;
    }

    async function fetchItemInfo() {
        const inputUrl = document.getElementById('urlInput').value;
        if (!inputUrl) {
            showAlert('请输入商品链接');
            return;
        }

        const urlMatch = extractHttpLink(inputUrl);
        if (!urlMatch) {
            showAlert('无效的链接格式');
            return;
        }

        let itemIdMatch = urlMatch.match(/itemID=([^&]*)/);
        if (!itemIdMatch) {
            const expandedUrl = await expandShortUrl(urlMatch);
            if (!expandedUrl) {
                return;
            }
            itemIdMatch = expandedUrl.match(/itemID=([^&]*)/);
            document.getElementById('urlInput').value = expandedUrl;
        }

        if (!itemIdMatch || !itemIdMatch[1]) {
            showAlert('无法获取商品ID');
            return;
        }

        const itemId = itemIdMatch[1];
        globalState.itemId = itemId;
        const param = encodeURIComponent(JSON.stringify({itemId: itemId}));
        const apiUrl = `/api/get/item/sku-info?param=${param}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'GET'
            });
            const payload = await response.json();
            if (!payload.success || !payload.data) {
                showAlert('API请求失败');
                return;
            }
            const data = payload.data;

            if (data.status.code !== 0) {
                showAlert('API请求失败: ' + data.status.message);
                return;
            }

            const result = data.result;
            globalState.itemPrice = result.itemOriginalLowPrice;
            globalState.itemStock = result.itemStock;
            globalState.result = result;  // 保存完整的返回结果
            displayProductInfo(result);
            displaySkuInfos(result.skuInfos);

        } catch (error) {
            console.error('获取商品信息失败:', error);
            showAlert('无法获取商品信息');
        }
    }

    function displayProductInfo(result) {
        const productInfoDiv = document.getElementById('productInfo');
        productInfoDiv.innerHTML = `
            <div class="product-card">
                <img src="${result.itemMainPic}" alt="${result.itemTitle}">
                <div class="product-details">
                    <h3>${result.itemTitle}</h3>
                    <div class="price-info">
                        <span class="price">¥${result.itemOriginalLowPrice / 100} - ${result.itemOriginalHighPrice / 100}</span>
                        <span class="stock">库存: ${result.itemStock}</span>
                    </div>
                    <div class="item-id">商品ID: ${result.itemId}</div>
                </div>
            </div>
        `;
    }

    function displaySkuInfos(skuInfos) {
        const skuInfoDiv = document.getElementById('skuInfo');
        skuInfoDiv.innerHTML = '<h3>SKU 信息</h3>';

        // 检查是否为价格日历商品
        if (globalState.result && globalState.result.calendarItem) {
            displayDateRanges(globalState.result.dateRangesPrice);
            return;
        }

        if (!skuInfos || skuInfos.length === 0) {
            skuInfoDiv.innerHTML += `
                <div class="sku-item">
                    <div class="sku-info">
                        <span>默认SKU - ¥${globalState.itemPrice / 100}</span>
                        <span class="stock">库存: ${globalState.itemStock}</span>
                    </div>
                    <div class="sku-action">
                        <input type="number" value="1" min="1" max="${globalState.itemStock}" id="quantity_0">
                        <button onclick="addSku(0, '默认SKU', ${globalState.itemPrice}, ${globalState.itemStock})">选择</button>
                    </div>
                </div>
            `;
            return;
        }

        skuInfos.forEach(sku => {
            const skuItemDiv = document.createElement('div');
            skuItemDiv.className = 'sku-item';
            skuItemDiv.innerHTML = `
                <div class="sku-info">
                    <span>${sku.skuInfo.title} - ¥${sku.skuInfo.originalPrice / 100}</span>
                    <span class="stock">库存: ${sku.skuInfo.stock}</span>
                </div>
                <div class="sku-action">
                    <input type="number" value="1" min="1" max="${sku.skuInfo.stock}" id="quantity_${sku.skuInfo.id}">
                    <button onclick="addSku(${sku.skuInfo.id}, '${sku.skuInfo.title}', ${sku.skuInfo.originalPrice}, ${sku.skuInfo.stock})">选择</button>
                </div>
            `;
            skuInfoDiv.appendChild(skuItemDiv);
        });
    }

    function displayDateRanges(dateRangesPrice) {
        const skuInfoDiv = document.getElementById('skuInfo');
        skuInfoDiv.innerHTML = '<h3>可选日期</h3>';
        
        dateRangesPrice.forEach(dateRange => {
            const date = dateRange.dateRanges[0];
            const timestamp = new Date(date).getTime();
            const skuItemDiv = document.createElement('div');
            skuItemDiv.className = 'sku-item';
            skuItemDiv.innerHTML = `
                <div class="sku-info">
                    <span>${date} - ¥${dateRange.price / 100}</span>
                </div>
                <div class="sku-action">
                    <input type="number" value="1" min="1" id="quantity_${timestamp}">
                    <button onclick="addDateSku('${date}', ${dateRange.price}, ${timestamp})">选择</button>
                </div>
            `;
            skuInfoDiv.appendChild(skuItemDiv);
        });
    }

    function addDateSku(date, price, timestamp) {
        const quantity = document.getElementById(`quantity_${timestamp}`).value;
        const existingSkuIndex = selectedSkus.findIndex(sku => sku.timestamp === timestamp);
        if (existingSkuIndex !== -1) {
            selectedSkus[existingSkuIndex] = {
                id: '',
                title: date,
                price,
                quantity,
                timestamp,
                isCalendarItem: true
            };
        } else {
            selectedSkus.push({
                id: '',
                title: date,
                price,
                quantity,
                timestamp,
                isCalendarItem: true
            });
        }
        updateSelectedSkus();
    }

    const selectedSkus = [];

    function addSku(id, title, price, stock) {
        const quantity = document.getElementById(`quantity_${id}`).value;
        const existingSkuIndex = selectedSkus.findIndex(sku => sku.id === id);
        if (existingSkuIndex !== -1) {
            selectedSkus[existingSkuIndex] = {id, title, price, quantity, stock};
        } else {
            selectedSkus.push({id, title, price, quantity, stock});
        }
        updateSelectedSkus();
    }

    function removeSku(index) {
        selectedSkus.splice(index, 1);
        updateSelectedSkus();
    }

    function updateSelectedSkus() {
        const selectedSkusDiv = document.getElementById('selectedSkus');
        selectedSkusDiv.innerHTML = '<h3>已选择SKU</h3>';
        selectedSkus.forEach((sku, index) => {
            selectedSkusDiv.innerHTML += `
                <div class="selected-sku-item">
                    <div class="sku-info">
                        <span>${sku.title} - ¥${sku.price / 100}</span>
                        <div class="quantity-control">
                            <span>数量:</span>
                            <input type="number" value="${sku.quantity}" min="1" max="${sku.stock}" onchange="updateQuantity(${index}, this.value)">
                            <button class="delete-button" onclick="removeSku(${index})">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        if (selectedSkus.length > 0) {
            selectedSkusDiv.innerHTML += '<button class="generate-button" onclick="generateOrderLink()">生成订单链接</button>';
        }
    }

    function updateQuantity(index, quantity) {
        selectedSkus[index].quantity = quantity;
    }

    function generateOrderLink() {
        if (selectedSkus.length === 0) {
            alert('请选择至少一个商品');
            return;
        }

        let orderLink;
        const firstSku = selectedSkus[0];
        
        if (firstSku.isCalendarItem) {
            const itemsParam = `${globalState.itemId}_${firstSku.quantity}_1__`;
            orderLink = `https://weidian.com/buy/add-order/index.php?items=${itemsParam}&page_name=&source_id=f5c9421654e92902b742e7037fd4626e&is_buy_now=1&timestamp=${firstSku.timestamp}`;
        } else {
            const itemsParam = selectedSkus.map(sku => `${globalState.itemId}_${sku.quantity}_1_${sku.id}`).join(',');
            orderLink = `https://weidian.com/buy/add-order/index.php?items=${itemsParam}&page_name=&source_id=f5c9421654e92902b742e7037fd4626e`;
        }

        const generatedLinkDiv = document.getElementById('generatedLink');
        generatedLinkDiv.innerHTML = `
            <h3>生成的订单链接</h3>
            <div class="link-container">
                <input type="text" value="${orderLink}" readonly>
                <button onclick="copyToClipboard('${orderLink}')">
                    <i class="ri-file-copy-line"></i>
                    复制
                </button>
            </div>
        `;
    }

    function copyToClipboard(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('已复制到剪切板');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showAlert('复制失败，请手动复制');
            });
        } else {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = 'fixed';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showAlert('已复制到剪切板');
            } catch (err) {
                console.error('Failed to copy using fallback method: ', err);
                showAlert('复制失败，请手动复制');
            }
            document.body.removeChild(textArea);
        }
    }

    function showAlert(message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'custom-alert';
        alertDiv.textContent = message;
        document.body.appendChild(alertDiv);

        // 显示提示
        setTimeout(() => alertDiv.classList.add('show'), 10);

        // 3秒后隐藏并移除
        setTimeout(() => {
            alertDiv.classList.remove('show');
            setTimeout(() => document.body.removeChild(alertDiv), 500);
        }, 3000);
    }
</script>
</body>
</html>
